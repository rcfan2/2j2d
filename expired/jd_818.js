/*
 * @Author: lxk0301 https://github.com/lxk0301
 * @Date: 2020-11-03 09:25:47
 * @Last Modified by: lxk0301
 * @Last Modified time: 2020-11-02 09:26:12
 */
/*
äº¬ä¸œæ‰‹æœºç‹‚æ¬¢åŸæ´»åŠ¨ï¼Œæ¯æ—¥å¯è·å¾—30+ä»¥ä¸Šäº¬è±†ï¼ˆå…¶ä¸­20äº¬è±†æ˜¯å¾€æœŸå¥–åŠ±ï¼Œéœ€ç¬¬ä¸€å¤©å‚åŠ æ´»åŠ¨åï¼Œç¬¬äºŒå¤©æ‰èƒ½æ‹¿åˆ°ï¼‰
æ´»åŠ¨æ—¶é—´10.21æ—¥-11.12æ—¥ç»“æŸï¼Œæ´»åŠ¨23å¤©ï¼Œä¿åº•æœ€å°‘å¯ä»¥æ‹¿åˆ°690äº¬è±†
æ´»åŠ¨åœ°å€: https://rdcseason.m.jd.com/#/index

å…¶ä¸­æœ‰20äº¬è±†æ˜¯å¾€æœŸå¥–åŠ±ï¼Œéœ€ç¬¬ä¸€å¤©å‚åŠ æ´»åŠ¨åï¼Œç¬¬äºŒå¤©æ‰èƒ½æ‹¿åˆ°ï¼ï¼ï¼ï¼


æ¯å¤©0/6/12/18ç‚¹é€›æ–°å“/åº—é“º/ä¼šåœºå¯è·å¾—äº¬è±†ï¼Œäº¬è±†å…ˆåˆ°å…ˆå¾—
å¾€æœŸå¥–åŠ±ä¸€èˆ¬æ¯å¤©éƒ½èƒ½æ‹¿20äº¬è±†

æ³¨ï¼šè„šæœ¬è¿è¡Œä¼šç»™æˆ‘æä¾›çš„åŠ©åŠ›ç åŠ©åŠ›ï¼Œä»‹æ„è€…å¯åˆ æ‰è„šæœ¬ç¬¬48è¡ŒhelpCodeé‡Œé¢çš„ä¸œè¥¿ã€‚ç•™ç©ºå³å¯ï¼ˆconst helpCode = []ï¼‰;

æ”¯æŒäº¬ä¸œåŒè´¦å·
è„šæœ¬å…¼å®¹: QuantumultX, Surge, Loon, JSBox, Node.js
// quantumultx
[task_local]
#äº¬ä¸œæ‰‹æœºç‹‚æ¬¢åŸ
1 0-18/6 * * * https://raw.githubusercontent.com/lxk0301/scripts/master/jd_818.js, tag=äº¬ä¸œæ‰‹æœºç‹‚æ¬¢åŸ, enabled=true
// Loon
[Script]
cron "1 0-18/6 * * *" script-path=https://raw.githubusercontent.com/lxk0301/scripts/master/jd_818.js,tag=äº¬ä¸œæ‰‹æœºç‹‚æ¬¢åŸ
// Surge
äº¬ä¸œæ‰‹æœºç‹‚æ¬¢åŸ = type=cron,cronexp=1 0-18/6 * * *,wake-system=1,timeout=20,script-path=https://raw.githubusercontent.com/lxk0301/scripts/master/jd_818.js
 */
const {Env} = require('../src/utils/Env')
const $ = new Env('äº¬ä¸œæ‰‹æœºç‹‚æ¬¢åŸ');

const notify = $.isNode() ? require('../src/utils/sendNotify') : '';
let jdNotify = false;//æ˜¯å¦å¼€å¯æ¨é€äº’åŠ©ç 
//Node.jsç”¨æˆ·è¯·åœ¨jdCookie.jså¤„å¡«å†™äº¬ä¸œck;
const jdCookieNode = $.isNode() ? require('../src/utils/jdCookie') : '';

//IOSç­‰ç”¨æˆ·ç›´æ¥ç”¨NobyDaçš„jd cookie
let cookiesArr = [], cookie = '';
if ($.isNode()) {
  Object.keys(jdCookieNode).forEach((item) => {
    cookiesArr.push(jdCookieNode[item])
  })
  if (process.env.JD_DEBUG && process.env.JD_DEBUG === 'false') console.log = () => {
  };
} else {
  cookiesArr.push($.getdata('CookieJD'));
  cookiesArr.push($.getdata('CookieJD2'));
}

const JD_API_HOST = 'https://rdcseason.m.jd.com/api/';
const activeEndTime = '2020/11/11 23:59:59+08:00';
const addUrl = 'http://jd.turinglabs.net/helpcode/create/';
const printUrl = `http://jd.turinglabs.net/helpcode/print/20/`;
let helpCode = []
!(async () => {
  if (!cookiesArr[0]) {
    $.msg($.name, 'ã€æç¤ºã€‘è¯·å…ˆè·å–äº¬ä¸œè´¦å·ä¸€cookie\nç›´æ¥ä½¿ç”¨NobyDaçš„äº¬ä¸œç­¾åˆ°è·å–', 'https://bean.m.jd.com/', {"open-url": "https://bean.m.jd.com/"});
    return;
  }
  $.temp = [];
  for (let i = 0; i < cookiesArr.length; i++) {
    if (cookiesArr[i]) {
      cookie = cookiesArr[i];
      $.UserName = decodeURIComponent(cookie.match(/pt_pin=(.+?);/) && cookie.match(/pt_pin=(.+?);/)[1])
      $.index = i + 1;
      $.isLogin = true;
      $.nickName = '';
      await TotalBean();
      console.log(`\nå¼€å§‹ã€äº¬ä¸œè´¦å·${$.index}ã€‘${$.nickName || $.UserName}\n`);
      if (!$.isLogin) {
        $.msg($.name, `ã€æç¤ºã€‘cookieå·²å¤±æ•ˆ`, `äº¬ä¸œè´¦å·${$.index} ${$.nickName || $.UserName}\nè¯·é‡æ–°ç™»å½•è·å–\nhttps://bean.m.jd.com/`, {"open-url": "https://bean.m.jd.com/"});
        $.setdata('', `CookieJD${i ? i + 1 : ""}`);//cookieå¤±æ•ˆï¼Œæ•…æ¸…ç©ºcookieã€‚
        if ($.isNode()) await notify.sendNotify(`${$.name}cookieå·²å¤±æ•ˆ - ${$.UserName}`, `äº¬ä¸œè´¦å·${$.index} ${$.UserName}\nè¯·é‡æ–°ç™»å½•è·å–cookie`);
        continue
      }
      message = '';
      subTitle = '';
      await JD818();
      // await getHelp();
      // await doHelp();
      // await main();
    }
  }
  // console.log($.temp)
})()
  .catch((e) => {
    $.log('', `âŒ ${$.name}, å¤±è´¥! åŸå› : ${e}!`, '')
  })
  .finally(() => {
    $.done();
  })

async function main() {
  // await getHelp();
  await Promise.all([
    getHelp(),
    listGoods(),
    shopInfo(),
    listMeeting(),
  ]);
  await $.wait(10000);
  await Promise.all([
    listGoods(),
    shopInfo(),
    listMeeting(),
    doHelp(),
    myRank(),
  ]);
  await Promise.all([
    getListJbean(),
    getListRank(),
    getListIntegral(),
  ]);
  await showMsg()
}

async function JD818() {
  await getHelp();
  await listGoods();//é€›æ–°å“
  await shopInfo();//é€›åº—é“º
  await listMeeting();//é€›ä¼šåœº
  await $.wait(10000);
  //å†æ¬¡è¿è¡Œä¸€æ¬¡ï¼Œé¿å…å‡ºç°é—æ¼çš„é—®é¢˜
  await listGoods();//é€›æ–°å“
  await shopInfo();//é€›åº—é“º
  await listMeeting();//é€›ä¼šåœº
  await doHelp();
  await myRank();//é¢†å–å¾€æœŸæ’åå¥–åŠ±
  await getListJbean();
  await getListRank();
  await getListIntegral();
  await showMsg()
}

function listMeeting() {
  const options = {
    'url': `${JD_API_HOST}task/listMeeting?t=${Date.now()}`,
    'headers': {
      'Host': 'rdcseason.m.jd.com',
      'Accept': 'application/json, text/plain, */*',
      'Connection': ' keep-alive',
      'Cookie': cookie,
      'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.14(0x17000e2a) NetType/4G Language/zh_CN',
      'Accept-Language': 'zh-cn',
      'Referer': `https://rdcseason.m.jd.com/?reloadWQPage=t_${Date.now()}`,
      'Accept-Encoding': 'gzip, deflate, br'
    }
  }
  return new Promise((resolve) => {
    $.get(options, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          // console.log('ddd----ddd', data.code)
          if (data.code === 200 && data.data.meetingList) {
            let integralNum = 0, jdNum = 0;
            for (let item of data.data.meetingList) {
              let res = await browseMeeting(item.id);
              if (res.code === 200) {
                let res2 = await getMeetingPrize(item.id);
                integralNum += res2.data.integralNum * 1;
                jdNum += res2.data.jdNum * 1;
              }
              // await browseMeeting('1596206323911');
              // await getMeetingPrize('1596206323911');
            }
            console.log(`é€›ä¼šåœº--è·å¾—ç§¯åˆ†:${integralNum}`)
            console.log(`é€›ä¼šåœº--è·å¾—äº¬è±†:${jdNum}`)
          }
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function listGoods() {
  const options = {
    'url': `${JD_API_HOST}task/listGoods?t=${Date.now()}`,
    'headers': {
      'Host': 'rdcseason.m.jd.com',
      'Accept': 'application/json, text/plain, */*',
      'Connection': ' keep-alive',
      'Cookie': cookie,
      'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.14(0x17000e2a) NetType/4G Language/zh_CN',
      'Accept-Language': 'zh-cn',
      'Referer': `https://rdcseason.m.jd.com/?reloadWQPage=t_${Date.now()}`,
      'Accept-Encoding': 'gzip, deflate, br'
    }
  }
  return new Promise((resolve) => {
    $.get(options, async (err, resp, data) => {
      try {
        // console.log('data1', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200 && data.data.goodsList) {
            let integralNum = 0, jdNum = 0;
            for (let item of data.data.goodsList) {
              let res = await browseGoods(item.id);
              if (res.code === 200) {
                let res2 = await getGoodsPrize(item.id);
                // console.log('é€›æ–°å“é¢†å–å¥–åŠ±res2', res2);
                integralNum += res2.data.integralNum * 1;
                jdNum += res2.data.jdNum * 1;
              }
            }
            console.log(`é€›æ–°å“è·å¾—ç§¯åˆ†:${integralNum}`)
            console.log(`é€›æ–°å“è·å¾—äº¬è±†:${jdNum}`)
          }
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  });
}

function shopInfo() {
  const options = {
    'url': `${JD_API_HOST}task/shopInfo?t=${Date.now()}`,
    'headers': {
      'Host': 'rdcseason.m.jd.com',
      'Accept': 'application/json, text/plain, */*',
      'Connection': ' keep-alive',
      'Cookie': cookie,
      'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.14(0x17000e2a) NetType/4G Language/zh_CN',
      'Accept-Language': 'zh-cn',
      'Referer': `https://rdcseason.m.jd.com/?reloadWQPage=t_${Date.now()}`,
      'Accept-Encoding': 'gzip, deflate, br'
    }
  }
  return new Promise((resolve) => {
    $.get(options, async (err, resp, data) => {
      try {
        // console.log('data1', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200 && data.data) {
            let integralNum = 0, jdNum = 0;
            for (let item of data.data) {
              let res = await browseShop(item.shopId);
              // console.log('res', res)
              // res = JSON.parse(res);
              // console.log('res', res.code)
              if (res.code === 200) {
                // console.log('---')
                let res2 = await getShopPrize(item.shopId);
                // console.log('res2', res2);
                // res2 = JSON.parse(res2);
                integralNum += res2.data.integralNum * 1;
                jdNum += res2.data.jdNum * 1;
              }
            }
            console.log(`é€›åº—é“ºè·å¾—ç§¯åˆ†:${integralNum}`)
            console.log(`é€›åº—é“ºè·å¾—äº¬è±†:${jdNum}`)
          }
        }
        // console.log('data1', data);
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve()
      }
    })
  })

}

function browseGoods(id) {
  const options = {
    "url": `${JD_API_HOST}task/browseGoods?t=${Date.now()}&skuId=${id}`,
    "headers": {
      "Host": "rdcseason.m.jd.com",
      "Accept": "application/json, text/plain, */*",
      "Connection": "keep-alive",
      "Cookie": cookie,
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
      "Accept-Language": "zh-cn",
      "Referer": "https://rdcseason.m.jd.com/",
      "Accept-Encoding": "gzip, deflate, br"
    }
  }
  return new Promise((resolve) => {
    $.get(options, (err, resp, data) => {
      try {
        // console.log('data1', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
        // console.log('data1', data);
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function getGoodsPrize(id) {
  const options = {
    "url": `${JD_API_HOST}task/getGoodsPrize?t=${Date.now()}&skuId=${id}`,
    "headers": {
      "Host": "rdcseason.m.jd.com",
      "Accept": "application/json, text/plain, */*",
      "Connection": "keep-alive",
      "Cookie": cookie,
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
      "Accept-Language": "zh-cn",
      "Referer": "https://rdcseason.m.jd.com/",
      "Accept-Encoding": "gzip, deflate, br"
    }
  }
  return new Promise((resolve) => {
    $.get(options, (err, resp, data) => {
      try {
        // console.log('data1', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function browseShop(id) {
  const options2 = {
    "url": `${JD_API_HOST}task/browseShop`,
    "body": `shopId=${id}`,
    "headers": {
      "Host": "rdcseason.m.jd.com",
      "Accept": "application/json, text/plain, */*",
      "Connection": "keep-alive",
      "Cookie": cookie,
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
      "Accept-Language": "zh-cn",
      "Referer": "https://rdcseason.m.jd.com/",
      "Accept-Encoding": "gzip, deflate, br"
    }
  }
  return new Promise((resolve) => {
    $.post(options2, (err, resp, data) => {
      try {
        // console.log('data1', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function getShopPrize(id) {
  const options = {
    "url": `${JD_API_HOST}task/getShopPrize`,
    "body": `shopId=${id}`,
    "headers": {
      "Host": "rdcseason.m.jd.com",
      "Accept": "application/json, text/plain, */*",
      "Connection": "keep-alive",
      "Cookie": cookie,
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
      "Accept-Language": "zh-cn",
      "Referer": "https://rdcseason.m.jd.com/",
      "Accept-Encoding": "gzip, deflate, br"
    }
  }
  return new Promise((resolve) => {
    $.post(options, (err, resp, data) => {
      try {
        // console.log('getShopPrize', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function browseMeeting(id) {
  const options2 = {
    "url": `${JD_API_HOST}task/browseMeeting`,
    "body": `meetingId=${id}`,
    "headers": {
      "Host": "rdcseason.m.jd.com",
      "Accept": "application/json, text/plain, */*",
      "Connection": "keep-alive",
      "Cookie": cookie,
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
      "Accept-Language": "zh-cn",
      "Referer": "https://rdcseason.m.jd.com/",
      "Accept-Encoding": "gzip, deflate, br"
    }
  }
  return new Promise((resolve) => {
    $.post(options2, (err, resp, data) => {
      try {
        // console.log('ç‚¹å‡»æµè§ˆä¼šåœº', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function getMeetingPrize(id) {
  const options = {
    "url": `${JD_API_HOST}task/getMeetingPrize`,
    "body": `meetingId=${id}`,
    "headers": {
      "Host": "rdcseason.m.jd.com",
      "Accept": "application/json, text/plain, */*",
      "Connection": "keep-alive",
      "Cookie": cookie,
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
      "Accept-Language": "zh-cn",
      "Referer": "https://rdcseason.m.jd.com/",
      "Accept-Encoding": "gzip, deflate, br"
    }
  }
  return new Promise((resolve) => {
    $.post(options, (err, resp, data) => {
      try {
        // console.log('getMeetingPrize', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp);
      } finally {
        resolve(data);
      }
    })
  })
}

function myRank() {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/myRank?t=${Date.now()}`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Accept": "application/json, text/plain, */*",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
        "Accept-Language": "zh-cn",
        "Referer": "https://rdcseason.m.jd.com/",
        "Accept-Encoding": "gzip, deflate, br"
      }
    }
    $.jbeanNum = '';
    $.get(options, async (err, resp, data) => {
      try {
        // console.log('æŸ¥è¯¢è·å¥–åˆ—è¡¨data', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200 && data.data.myHis) {
            for (let i = 0; i < data.data.myHis.length; i++) {
              $.date = data.data.myHis[0].date;
              if (data.data.myHis[i].status === '21') {
                await $.wait(1000);
                console.log('å¼€å§‹é¢†å¥–')
                let res = await saveJbean(data.data.myHis[i].id);
                // console.log('é¢†å¥–ç»“æœ', res)
                if (res.code === 200 && res.data.rsCode === 200) {
                  // $.jbeanNum += Number(res.data.jbeanNum);
                  console.log(`${data.data.myHis[i].date}æ—¥å¥–åŠ±é¢†å–æˆåŠŸ${JSON.stringify(res.data.jbeanNum)}`)
                }
              }
              if (i === 0 && data.data.myHis[i].status === '22') {
                $.jbeanNum = data.data.myHis[i].prize;
              }
            }
            // for (let item of data.data.myHis){
            //   if (item.status === '21') {
            //     await $.wait(1000);
            //     console.log('å¼€å§‹é¢†å¥–')
            //     let res = await saveJbean(item.id);
            //     // console.log('é¢†å¥–ç»“æœ', res)
            //     if (res.code === 200 && res.data.rsCode === 200) {
            //       $.jbeanNum += Number(res.data.jbeanNum);
            //     }
            //   }
            // }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function saveJbean(id) {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/saveJbean`,
      "body": `prizeId=${id}`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Accept": "application/json, text/plain, */*",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_5_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Mobile/15E148 Safari/604.1",
        "Accept-Language": "zh-cn",
        "Referer": "https://rdcseason.m.jd.com/",
        "Accept-Encoding": "gzip, deflate, br"
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        // console.log('é¢†å–äº¬è±†ç»“æœ', data);
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

async function doHelp() {
  console.log(`è„šæœ¬è‡ªå¸¦åŠ©åŠ›ç æ•°é‡:${helpCode.length}`)
  let body = '', nowTime = Date.now(), tempCode = [];
  const zone = new Date().getTimezoneOffset();
  if (zone === 0) {
    nowTime += 28800000;//UTC-0æ—¶åŒºåŠ ä¸Š8ä¸ªå°æ—¶
  }
  await updateShareCodes();
  if (!$.updatePkActivityIdRes) await updateShareCodesCDN();
  tempCode = $.updatePkActivityIdRes.shareCodes;
  console.log(`æ˜¯å¦å¤§äºå½“å¤©ä¹ç‚¹ğŸ•˜:${nowTime > new Date(nowTime).setHours(9, 0, 0, 0)}`)
  //å½“å¤©å¤§äº9:00æ‰ä»APIé‡Œé¢å–æ”¶é›†çš„åŠ©åŠ›ç 
  if (nowTime > new Date(nowTime).setHours(9, 0, 0, 0)) body = await printAPI();//è®¿é—®æ”¶é›†çš„äº’åŠ©ç 
  if (body) {
    console.log(`printAPIè¿”å›åŠ©åŠ›ç æ•°é‡:${body.replace(/"/g, '').split(',').length}`)
    tempCode = tempCode.concat(body.replace(/"/g, '').split(','))
  }
  console.log(`ç´¯è®¡åŠ©åŠ›ç æ•°é‡:${tempCode.length}`)
  //å»æ‰é‡å¤çš„
  tempCode = [...new Set(tempCode)];
  console.log(`å»é‡åæ€»åŠ©åŠ›ç æ•°é‡:${tempCode.length}`)
  for (let item of tempCode) {
    if (!item) continue;
    const helpRes = await toHelp(item.trim());
    if (helpRes.data.status === 5) {
      console.log(`åŠ©åŠ›æœºä¼šå·²è€—å°½ï¼Œè·³å‡ºåŠ©åŠ›`);
      break;
    }
  }
}

function printAPI() {
  return new Promise(resolve => {
    $.get({url: `${printUrl}`}, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          // data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function toHelp(code) {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/toHelp`,
      "body": `shareId=${code}`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Content-Type": "application/x-www-form-urlencoded",
        "Origin": "https://rdcseason.m.jd.com",
        "Accept-Encoding": "gzip, deflate, br",
        "Cookie": cookie,
        "Connection": "keep-alive",
        "Accept": "application/json, text/plain, */*",
        "User-Agent": "jdapp;iPhone;9.1.0;14.0;e35caf0a69be42084e3c97eef56c3af7b0262d01;network/4g;supportApplePay/3;hasUPPay/0;pushNoticeIsOpen/1;model/iPhone11,8;addressid/2005183373;hasOCPay/0;appBuild/167348;supportBestPay/0;jdSupportDarkMode/0;pv/252.3;apprpd/Home_Main;ref/JDWebViewController;psq/2;ads/;psn/e35caf0a69be42084e3c97eef56c3af7b0262d01|695;jdv/0|kong|t_2010957099_|jingfen|3b5422e836e74037862fea3dcf1a6802|1600647811440|1600647814;adk/;app_device/IOS;pap/JA2015_311210|9.1.0|IOS 14.0;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148;supportJDSHWK/1",
        "Referer": "https://rdcseason.m.jd.com/",
        "Content-Length": "44",
        "Accept-Language": "zh-cn"
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          console.log(`åŠ©åŠ›ç»“æœ:${data}`);
          data = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function getHelp() {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/getHelp?t=${Date.now()}`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Accept": "application/json, text/plain, */*",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "User-Agent": "jdapp;iPhone;9.1.0;14.0;e35caf0a69be42084e3c97eef56c3af7b0262d01;network/4g;supportApplePay/3;hasUPPay/0;pushNoticeIsOpen/1;model/iPhone11,8;addressid/2005183373;hasOCPay/0;appBuild/167348;supportBestPay/0;jdSupportDarkMode/0;pv/255.2;apprpd/Home_Main;ref/JDMainPageViewController;psq/1;ads/;psn/e35caf0a69be42084e3c97eef56c3af7b0262d01|701;jdv/0|kong|t_2010957099_|jingfen|3b5422e836e74037862fea3dcf1a6802|1600647811440|1600647814;adk/;app_device/IOS;pap/JA2015_311210|9.1.0|IOS 14.0;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148;supportJDSHWK/1",
        "Accept-Language": "zh-cn",
        "Referer": "https://rdcseason.m.jd.com",
        "Accept-Encoding": "gzip, deflate, br"
      }
    }
    $.get(options, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200) {
            console.log(`\næ‚¨çš„åŠ©åŠ›ç shareId(äº’åŠ©ç æ¯å¤©éƒ½æ˜¯å˜åŒ–çš„)\n\n"${data.data.shareId}",\n`);
            console.log(`æ¯æ—¥9:00ä»¥åå¤åˆ¶ä¸‹é¢çš„URLé“¾æ¥åœ¨æµè§ˆå™¨é‡Œé¢æ‰“å¼€ä¸€æ¬¡å°±èƒ½è‡ªåŠ¨ä¸Šè½¦\n\n${addUrl}${data.data.shareId}\n`);
            let ctrTemp;
            if ($.isNode() && process.env.JD_818_SHAREID_NOTIFY) {
              console.log(`ç¯å¢ƒå˜é‡JD_818_SHAREID_NOTIFY::${process.env.JD_818_SHAREID_NOTIFY}`)
              ctrTemp = `${process.env.JD_818_SHAREID_NOTIFY}` === 'true';
            } else {
              ctrTemp = `${jdNotify}` === 'true';
            }
            console.log(`æ˜¯å¦å‘é€ä¸Šè½¦æ¨é€é“¾æ¥:${ctrTemp ? 'æ˜¯' : 'å¦'}`)
            // åªåœ¨æ—©æ™¨9ç‚¹é’Ÿè§¦å‘ä¸€æ¬¡
            let NowHours = new Date().getHours();
            const zone = new Date().getTimezoneOffset();
            if (zone === 0) {
              NowHours += 8;//UTC-0æ—¶åŒºåŠ ä¸Š8ä¸ªå°æ—¶
            }
            if (ctrTemp && NowHours === 9 && $.isNode()) await notify.sendNotify(`${$.name} - è´¦å·${$.index} - ${$.nickName}äº’åŠ©ç è‡ªåŠ¨ä¸Šè½¦`, `[9:00ä¹‹åä¸Šè½¦]æ‚¨çš„äº’åŠ©ç ä¸Šè½¦é“¾æ¥æ˜¯ â†“â†“â†“ \n\n ${addUrl}${data.data.shareId} \n\n â†‘â†‘â†‘`, {
              url: `${addUrl}${data.data.shareId}`
            })
            // await $.http.get({url: `http://jd.turinglabs.net/helpcode/add/${data.data.shareId}/`}).then((resp) => {
            //   console.log(resp);
            //   return
            //   if (resp.statusCode === 200) {
            //     const { body } = resp;
            //   }
            // });
            $.temp.push(data.data.shareId);
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

//è·å–å½“å‰æ´»åŠ¨æ€»äº¬è±†æ•°é‡
function getListJbean() {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/listJbean?pageNum=1`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Accept": "application/json, text/plain, */*",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "User-Agent": "jdapp;iPhone;9.1.0;14.0;e35caf0a69be42084e3c97eef56c3af7b0262d01;network/4g;supportApplePay/3;hasUPPay/0;pushNoticeIsOpen/1;model/iPhone11,8;addressid/2005183373;hasOCPay/0;appBuild/167348;supportBestPay/0;jdSupportDarkMode/0;pv/255.2;apprpd/Home_Main;ref/JDMainPageViewController;psq/1;ads/;psn/e35caf0a69be42084e3c97eef56c3af7b0262d01|701;jdv/0|kong|t_2010957099_|jingfen|3b5422e836e74037862fea3dcf1a6802|1600647811440|1600647814;adk/;app_device/IOS;pap/JA2015_311210|9.1.0|IOS 14.0;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148;supportJDSHWK/1",
        "Accept-Language": "zh-cn",
        "Referer": "https://rdcseason.m.jd.com",
        "Accept-Encoding": "gzip, deflate, br"
      }
    }
    $.get(options, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200) {
            $.jbeanCount = data.data.jbeanCount;
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function getListIntegral() {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/listIntegral?pageNum=1`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Accept": "application/json, text/plain, */*",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "User-Agent": "jdapp;iPhone;9.1.0;14.0;e35caf0a69be42084e3c97eef56c3af7b0262d01;network/4g;supportApplePay/3;hasUPPay/0;pushNoticeIsOpen/1;model/iPhone11,8;addressid/2005183373;hasOCPay/0;appBuild/167348;supportBestPay/0;jdSupportDarkMode/0;pv/255.2;apprpd/Home_Main;ref/JDMainPageViewController;psq/1;ads/;psn/e35caf0a69be42084e3c97eef56c3af7b0262d01|701;jdv/0|kong|t_2010957099_|jingfen|3b5422e836e74037862fea3dcf1a6802|1600647811440|1600647814;adk/;app_device/IOS;pap/JA2015_311210|9.1.0|IOS 14.0;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148;supportJDSHWK/1",
        "Accept-Language": "zh-cn",
        "Referer": "https://rdcseason.m.jd.com",
        "Accept-Encoding": "gzip, deflate, br"
      }
    }
    $.get(options, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200) {
            $.integralCount = data.data.integralCount;
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

//æŸ¥è¯¢ä»Šæ—¥ç´¯è®¡ç§¯åˆ†ä¸æ’å
function getListRank() {
  return new Promise(resolve => {
    const options = {
      "url": `${JD_API_HOST}task/listRank?t=${Date.now()}`,
      "headers": {
        "Host": "rdcseason.m.jd.com",
        "Accept": "application/json, text/plain, */*",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "User-Agent": "jdapp;iPhone;9.1.0;14.0;e35caf0a69be42084e3c97eef56c3af7b0262d01;network/4g;supportApplePay/3;hasUPPay/0;pushNoticeIsOpen/1;model/iPhone11,8;addressid/2005183373;hasOCPay/0;appBuild/167348;supportBestPay/0;jdSupportDarkMode/0;pv/255.2;apprpd/Home_Main;ref/JDMainPageViewController;psq/1;ads/;psn/e35caf0a69be42084e3c97eef56c3af7b0262d01|701;jdv/0|kong|t_2010957099_|jingfen|3b5422e836e74037862fea3dcf1a6802|1600647811440|1600647814;adk/;app_device/IOS;pap/JA2015_311210|9.1.0|IOS 14.0;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148;supportJDSHWK/1",
        "Accept-Language": "zh-cn",
        "Referer": "https://rdcseason.m.jd.com",
        "Accept-Encoding": "gzip, deflate, br"
      }
    }
    $.get(options, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          data = JSON.parse(data);
          if (data.code === 200) {
            if (data.data.my) {
              $.integer = data.data.my.integer;
              $.num = data.data.my.num;
            }
            if (data.data.last) {
              $.lasNum = data.data.last.num;
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

function updateShareCodes(url = 'https://raw.githubusercontent.com/lxk0301/updateTeam/master/jd_shareCodes.json') {
  return new Promise(resolve => {
    //https://cdn.jsdelivr.net/gh/lxk0301/updateTeam@master/jd_shareCodes.json
    //https://raw.githubusercontent.com/lxk0301/updateTeam/master/jd_shareCodes.json
    $.get({url}, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
        } else {
          $.updatePkActivityIdRes = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}

function updateShareCodesCDN(url = 'https://cdn.jsdelivr.net/gh/lxk0301/updateTeam@master/jd_shareCodes.json') {
  return new Promise(resolve => {
    //https://cdn.jsdelivr.net/gh/lxk0301/updateTeam@master/jd_shareCodes.json
    //https://raw.githubusercontent.com/lxk0301/updateTeam/master/jd_shareCodes.json
    $.get({url}, async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          $.updatePkActivityIdRes = JSON.parse(data);
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}

function TotalBean() {
  return new Promise(async resolve => {
    const options = {
      "url": `https://wq.jd.com/user/info/QueryJDUserInfo?sceneval=2`,
      "headers": {
        "Accept": "application/json,text/plain, */*",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-cn",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "Referer": "https://wqs.jd.com/my/jingdou/my.shtml?sceneval=2",
        "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0 Mobile/15E148 Safari/604.1"
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (data) {
            data = JSON.parse(data);
            if (data['retcode'] === 13) {
              $.isLogin = false; //cookieè¿‡æœŸ
              return
            }
            $.nickName = data['base'].nickname;
          } else {
            console.log(`äº¬ä¸œæœåŠ¡å™¨è¿”å›ç©ºæ•°æ®`)
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}

async function showMsg() {
  if (Date.now() > new Date(activeEndTime).getTime()) {
    $.msg($.name, 'æ´»åŠ¨å·²ç»“æŸ', `è¯¥æ´»åŠ¨ç´¯è®¡è·å¾—äº¬è±†ï¼š${$.jbeanCount}ä¸ª\niOSç”¨æˆ·è¯·åˆ é™¤æ­¤è„šæœ¬\ngithub actionç”¨æˆ·è¯·åˆ é™¤.github/workflows/jd_818.ymlæ–‡ä»¶\nå¦‚æœå¸®åŠ©åˆ°æ‚¨å¯ä»¥ç‚¹ä¸‹ğŸŒŸSTARé¼“åŠ±æˆ‘ä¸€ä¸‹,è°¢è°¢\nå’±æ±Ÿæ¹–å†è§\nhttps://github.com/lxk0301/scripts`, {"open-url": "https://github.com/lxk0301/scripts"});
    if ($.isNode()) await notify.sendNotify($.name + 'æ´»åŠ¨å·²ç»“æŸ', `è¯·åˆ é™¤æ­¤è„šæœ¬\ngithub actionç”¨æˆ·è¯·åˆ é™¤.github/workflows/jd_818.ymlæ–‡ä»¶\nå¦‚æœå¸®åŠ©åˆ°æ‚¨å¯ä»¥ç‚¹ä¸‹ğŸŒŸSTARé¼“åŠ±æˆ‘ä¸€ä¸‹,è°¢è°¢\nå’±æ±Ÿæ¹–å†è§\n https://github.com/lxk0301/scripts`)
  } else {
    $.msg($.name, `äº¬ä¸œè´¦å·${$.index} ${$.nickName || $.UserName}`, `${$.jbeanCount ? `${$.integer ? `ä»Šæ—¥è·å¾—ç§¯åˆ†ï¼š${$.integer}ä¸ª\n` : ''}${$.num ? `ä»Šæ—¥æ’åï¼š${$.num}\n` : ''}ä»Šæ—¥å‚æ•°äººæ•°ï¼š${$.lasNum}äºº\nç´¯è®¡è·å¾—äº¬è±†ï¼š${$.jbeanCount}ä¸ªğŸ¶\n` : ''}${$.jbeanCount ? `ç´¯è®¡è·å¾—ç§¯åˆ†ï¼š${$.integralCount}ä¸ª\n` : ''}${$.jbeanNum ? `${$.date}æ—¥å¥–å“ï¼š${$.jbeanNum}\n` : ''}å…·ä½“è¯¦æƒ…ç‚¹å‡»å¼¹çª—è·³è½¬åå³å¯æŸ¥çœ‹`, {"open-url": "https://rdcseason.m.jd.com/#/hame"});
  }
}
